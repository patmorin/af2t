\documentclass{patmorin}
\listfiles
\usepackage{pat}
\usepackage{paralist}
\usepackage{dsfont}  % for \mathds{A}
\usepackage[utf8x]{inputenc}
\usepackage{skull}
\usepackage{paralist}
\usepackage{graphicx}
\usepackage[noend]{algorithmic}

\usepackage[normalem]{ulem}
\usepackage{cancel}
\usepackage{enumitem}

\usepackage{todonotes}

\usepackage[longnamesfirst,numbers,sort&compress]{natbib}

\usepackage[mathlines]{lineno}
\setlength{\linenumbersep}{2em}
% \linenumbers
% \rightlinenumbers
% \linenumbers
\newcommand*\patchAmsMathEnvironmentForLineno[1]{%
 \expandafter\let\csname old#1\expandafter\endcsname\csname #1\endcsname
 \expandafter\let\csname oldend#1\expandafter\endcsname\csname end#1\endcsname
 \renewenvironment{#1}%
    {\linenomath\csname old#1\endcsname}%
    {\csname oldend#1\endcsname\endlinenomath}}%
\newcommand*\patchBothAmsMathEnvironmentsForLineno[1]{%
 \patchAmsMathEnvironmentForLineno{#1}%
 \patchAmsMathEnvironmentForLineno{#1*}}%
\AtBeginDocument{%
\patchBothAmsMathEnvironmentsForLineno{equation}%
\patchBothAmsMathEnvironmentsForLineno{align}%
\patchBothAmsMathEnvironmentsForLineno{flalign}%
\patchBothAmsMathEnvironmentsForLineno{alignat}%
\patchBothAmsMathEnvironmentsForLineno{gather}%
\patchBothAmsMathEnvironmentsForLineno{multline}%
}


\newcommand{\coloured}[2]{{\color{#1}{#2}}}
\newenvironment{colourblock}[1]{\color{#1}}{}

\newcommand{\condref}[1]{(C\ref{#1})}

% Taken from
% https://tex.stackexchange.com/questions/42726/align-but-show-one-equation-number-at-the-end
\newcommand\numberthis{\addtocounter{equation}{1}\tag{\theequation}}


\setlength{\parskip}{1ex}


\DeclareMathOperator{\diam}{diam}
\DeclareMathOperator{\tw}{tw}
\DeclareMathOperator{\stw}{stw}
\DeclareMathOperator{\ltw}{ltw}
\DeclareMathOperator{\pw}{pw}
\DeclareMathOperator{\lpw}{lpw}
\DeclareMathOperator{\lhptw}{lhp-tw}
\DeclareMathOperator{\lhppw}{lhp-pw}

\DeclareMathOperator{\x}{x}
\DeclareMathOperator{\depth}{d}
\DeclareMathOperator{\sh}{cbt}
\DeclareMathOperator{\cbt}{cbt}
\DeclareMathOperator{\sgn}{sgn}
\DeclareMathOperator{\dc}{dc}

\DeclareMathOperator{\afci}{\overline{\chi}_\pi}
\DeclareMathOperator{\afcn}{\dot{\chi}_\pi}

\newcommand{\ellt}{{\lfloor\ell/2\rfloor}}

\title{\MakeUppercase{Pathwidth-$2$ Graphs have Unbounded Anagram-Free Chromatic Number}\thanks{This research was partly funded by NSERC.}}
\author{Saman Bazarghani%
    \thanks{Department of Computer Science and Electrical Engineering, University of Ottawa}\qquad
    Therese Biedl%
    \thanks{Department of Computer Science and Electrical Engineering, University of Ottawa}\qquad
    Vida DujmoviÄ‡\footnotemark[2]\qquad
    Pat Morin\footnotemark[3]%
    \thanks{School of Computer Science, Carleton University}}

\DeclareMathOperator{\ddiv}{div}
\DeclareMathOperator{\hist}{h}

\newcommand{\colored}[2]{{\color{#1}#2}}

\usepackage{tabularx}

\DeclareMathOperator{\ci}{\overline{\pi}}

\begin{document}

% \begin{titlepage}
\maketitle

\begin{abstract}
    We show that outerplanar graphs of pathwidth $2$ do do not have anagram-free edge or vertex colourings with a bounded number of colours.
\end{abstract}
% \end{titlepage}

% \pagenumbering{roman}
% \tableofcontents
%
% \newpage
% \pagenumbering{arabic}


\section{Introduction}

Two strings $s$ and $t$ are said to be \emph{anagrams} of each other if $s$ is a permutation of $t$.  A single string $s:=s_1,\ldots,s_{2r}$ is \emph{anagramish} if its first half $s_1,\ldots,s_r$ and its second half $s_{r+1},\ldots,s_{2r}$ ar anagrams of each other.

A \emph{vertex $c$-colouring} $\phi:V(G)\to\{1,\ldots,c\}$ is \emph{anagram-free} if $G$ has no path $v_1,\ldots,v_{2r}$ such that $\phi(v_1),\ldots,\phi(v_{2r})$ is anagramish.

\todo[inline]{Previous work and obvious gap (pathwidth-2)}


\begin{thm}\label{main_vertex}
    For every $c\in\N$, there exists a graph of $G$ of pathwidth $2$ that has no anagram-free vertex $c$-colouring.
\end{thm}

% \todo[inline]{Statement of vertex colouring result (hopefully)}
%
% An \emph{edge $c$-colouring} $\varphi:E(G)\to\{1,\ldots,c\}$ is \emph{anagram-free} if $G$ has no path $v_0,\ldots,v_{2r}$ such that $\varphi(v_0v_1),\ldots,\varphi(v_{2r-1}v_{2r})$ is anagramish.  We also give an edge colouring version of \cref{main_vertex}.
%
% \begin{thm}\label{main_edge}
%     For every $c\in\N$, there exists a graph of $G$ of pathwidth $2$ that has no anagram-free edge $c$-colouring.
% \end{thm}


\todo[inline]{Relation to Existing Work}

The remainder of the paper is organized as follows.  In \cref{near_anagram_statement} we state the main lemma, which shows that, under a certain periodicity condition, every sufficiently long string contains a substring that is $\epsilon$-close to being anagramish.
% In \cref{edge_colourings} we prove \cref{main_edge}.
In \cref{vertex_colourings} we prove \cref{main_vertex}.  Finally, in \cref{near_anagram_proof} we prove the main lemma.

\section{Statement of the Main Lemma}
\label{near_anagram_statement}

Let $s:=s_1,\ldots,s_n$ be a string over an alphabet $\Sigma:=\{s_i:i\in\{1,\ldots,n\}\}$ and, for each $a\in \Sigma$, define $\hist_a(s):=|\{i\in\{1,\ldots,n\}:s_i=a\}$.  The \emph{histogram} of $s$ is the integer-valued $|\Sigma|$-vector $\hist(s):=(\hist_a(s):a\in\Sigma)$ indexed by elements of $\Sigma$.  Let $\|\cdot\|_1$ denote the L1 norm of a vector.\footnote{For real-valued $d$-vector $\boldsymbol{v}:=(v_1,\ldots,v_d)$, $\|\boldsymbol{V}\|_1=\sum_{i=1}^d|v_i|$.}  Note that a string $s_1,\ldots,s_{2r}$ is anagramish if and only if $\hist(s_1,\ldots,s_r)=\hist(s_{r+1},\ldots,s_{2r})$.  Equivalently, $\hist(s_1,\ldots,s_r)-\hist(s_{r+1},\ldots,s_{2r})=\boldsymbol{0}$ or
$\|\hist(s_1,\ldots,s_r)-\hist(s_{r+1},\ldots,s_{2r})\|_1=0$.

A string $s:=s_1,\ldots,s_n$ is $\ell$-periodic if each length-$\ell$ substring of $s$ contains every character in $\Sigma:=\bigcup_{i=1}^n s_i$.  We make use of the following lemma, which states that every sufficiently long $\ell$-periodic string contains a substring that is $\epsilon$-close to being anagramish.

\begin{lem}\label{near_anagram_fourier}
    For each $C,r_0,\ell\in\N$ and each $\epsilon>0$, there exists a positive integer $N$ such that each anagram-free\todo{Do we need anagram-free specifically, or can use a generic property?} $\ell$-periodic string $s_1,\ldots,s_N\in\{1,\ldots,C\}^N$\todo{Do we need $C$ here, or is $\ell$-periodic enough?} contains a substring $s_{i+1},\ldots,s_{i+2r}$ of length $2r \ge 2r_0$ such that $\|\hist(s_{i+1},\ldots,s_{i+r})-\hist(s_{i+r+1},\ldots,s_{i+2r})\|_1 \le \epsilon r$.
\end{lem}

The proof of \cref{near_anagram_fourier} is deferred to \cref{near_anagram_proof}.  We now give some intuition as to how it is used.  The process of checking if a string is anagramish is often viewed as finding common terms in the first and second halves and crossing them both out.  If this results in a complete cancellation of all terms, then the string is an anagram.  \cref{near_anagram_fourier} tells us that we can always find a substring where, after exhaustive cancellation, only an $\epsilon$ fraction of the original terms remain.

Our strategy is to use \cref{near_anagram_fourier} to show that, if four terms in one half are allowed to gang up and cancel six terms in the other half then (under conditions that we guarantee) we will be able to fully complete the cancellation process.  To achieve this type of four versus six cancellation, we study a small subgraph that has a set of four paths that use every edge exactly twice and also has a set of three paths that use every edge exactly once.  Using the latter set of paths twice gives a collection of six paths that covers every edge twice.  Thus four terms in one half can be used to cancel six terms in the other half.

Note that \cref{near_anagram_fourier} requires that the string $s$ be $\ell$-periodic.  The following lemma will be helpful in obtaining strings that can be used with \cref{near_anagram_fourier}.

\begin{lem}\label{periodicity}
    Let $\Sigma$ be a finite set and let $P:A^*\to\{0,1\}$ be a function such that,
    \begin{compactenum}[({A}1)]
        \item if $P(s')=0$ for some substring $s'$ of $s$ then $P(s)=0$; and
        \item for each $n\in\N$, there exists at least one $s\in A^n$ such that $P(s)=1$.
    \end{compactenum}
    Then there exists $\ell\in\N$ and $\Xi\subseteq A$ such that, for each $n\in\N$,
    \begin{compactenum}[(C1)]
        \item there exists $s\in\Xi^n$ such that $P(s)=1$; and
        \item every string in $s\in\Xi^n$ with $P(s)=1$ is $\ell$-periodic.
    \end{compactenum}
\end{lem}

\begin{proof}
    Take $\Xi$ to be a minimal subset of $\Sigma$ such that there exists $s\in\Xi^n$ with $P(s)=1$, for each $n\in N$.  Such a $\Xi$ exists by (A2) and the fact that $\Sigma$ is finite. By definition $\Xi$ satisfies (C1) so we need only show that it also satisifies (C2).  If $|\Xi|=1$ then we are done since every string over a $1$-character alphabet is $1$-periodic.

    For $|\Xi|>1$, the minimality of $\Xi$ implies that, for any $a\in\Xi$, there exist $\ell_a\in\N$ such that $P(s)=0$ for each $s\in\Xi^{\ell_a}$.  Therefore (A2) implies that, for each $\ell\ge\ell_a$, $P(s)=0$ for each $s\in\Xi^{\ell}$. Set $\ell:=\max\{\ell_a:a\in \Xi\}$.  Now (A1) implies that, for every $s\in\Xi$, every length $\ell$-substring of $s$ contains every character in $\Xi$, so $s$ is $\ell$-periodic.
\end{proof}


\section{Vertex Colouring}
\label{vertex_colourings}

For each $n\in\N$, let $G_n$ be the $2\times n$ square grid with top row $a_0,\ldots,a_{n-1}$ and bottom row $b_0,\ldots,b_{n-1}$ (see \cref{g_n}). For convenience, we let $G:=G_\infty$.  For each $i,j\in\N$ with $i\le j$, define $G[i,j]:=G[\bigcup_{k=i}^{j-1}\{a_k,b_k\}]$ and we call $G[i,j]$ a \emph{$(j-i)$-block}. Note that each $t$-block $G[i,i+t]$ is isomorphic to $G_t$ with the mapping $f:G_t\to V(G[i,i+t])$ given by $f_i(a_{j}):=a_{i+j}$ and $f_i(b_{j}):=b_{i+j}$ for each $j\in\{0,\ldots,t\}$.

\begin{figure}
    \begin{center}
    % \includegraphics{figs/g_n}
\end{center}
\caption{The graph $G_n$}
\label{g_n}
\end{figure}

For each $n\in\N$, let $\Phi_{c,n}$ be the set of all $c^{2n}$ functions $\phi:V(G_n)\to\{1,\ldots,c\}$, i.e., all vertex $c$-colourings of $G_n$.
Given some $\phi\in\Phi_{c,n}$, each $t$-block $G[i,i+t]$ defines a vertex colouring $\phi[i,i+t]\in \Phi_{c,t}$ of $G_t$ defined as $\phi[i,i+t](v):=\phi(f_i(v))$ for each $v\in V(G[i,i+t])$.

Our strategy will be to break $G_n$ up into small pieces using $4$-blocks that all have the same colouring. Observe that any string $s:=\phi_0,\ldots,\phi_{b-1}\in\Phi_{c,4}^b$ defines a vertex $c$-colouring $\phi_s$ of the graph $G_{4b}$ where $\phi[4j,4j+4]:=\phi_j$ for each $j\in\{0,\ldots,b-1\}$.  Indeed, there is a bijection between $c$-colourings of $G_{4b}$ and strings in $\Phi_{c,4}^b$.

\begin{lem}\label{breakers}
    If $\afcn(G_n)\le c$ for each $n\in\N$ then there exists $\ell\in\N$ such that, for each $b\in\N$ there exists an $\ell$-periodic $s\in\Phi_{c,4}^b$ such that $\phi_s$ is an anagram-free vertex colouring of $G_{4b}$.
\end{lem}

\begin{proof}
    For any $s\in\Phi_{c,4}^*$, let $P(s):=1$ if $\phi_s$ is an anagram-free colouring of $G_{4|s|}$ and let $P(s):=0$ otherwise.  Then $P$ has property (A1) of \cref{periodicity} since any substring of $s'$ of $s$ defines a colouring of $G_{4|s'|}$ that appears in the colouring of $G_{4|s|}$; if the colouring $\phi_{s'}$ of $G_{4|s'|}$ is not anagram-free then neither is the colouring $\phi_s$ of $G_{4|s|}$. By assumption, $\afcn(G)\le c$, so $G_{4b}$ has some anagram-free vertex $c$-colouring, so $P$ also satisfies property (A2) of \cref{periodicity}.  The result now follows from  \cref{periodicity}.
\end{proof}

Let $\Sigma$ be the set of tuples $(k,\phi)$ where $k\in\{1,\ldots,\ell\}$ and $\phi\in\Phi_{4k}$ is a vertex $c$-colouring of $G_{4k}$.  For a string $s:=(k_1,\phi_1),\ldots,(k_r,\phi_r)\in\Sigma^*$ we define $n_{s,i}:=4(i+\sum_{j=1}^i k_j)$, $n_s:=n_{s,r}$, and the colouring $\varphi_s$ of $G_{n_s}$ as follows:
\begin{compactenum}
    \item for each $i\in\{0,\ldots,r\}$, $\phi[n_{s,i},n_{s,i+4}]:=\phi^*$, where $\phi^*$ is defined in \cref{breakers};
    \item for each $i\in\{1,\ldots,r\}$, $\phi[n_{s,i},n_{s,i+1}-4]:=\phi_i$.
\end{compactenum}
In words, $G_{n_s}$ decomposed into blocks each of whose length is a multiple of $4$.  There are \emph{colourful} blocks of lengths $4k_1,4k_2,\ldots,4k_{|s|}\le 4\ell$ and these are interleaved with \emph{boring} blocks, each of length $4$.  The colourful blocks have their vertex colours determined by $s$. The boring blocks are coloured the same way, by $\phi^*$.

Define the function $P:\Sigma^*\to\{0,1\}$ so that $P(s):=1$ if and only if $\phi_s$ is an anagram-free colouring of $G_{n_s}$.  Observe that any substring $s'$ of $s$ defines a colouring $\phi_{s'}$ of $G_{n_s'}$ that appears in the colouring $\phi_s$ of $G_{n_s}$. Therefore $P$ satisfies property (A1) of \cref{periodicity}.  Furthermore, if $\afcn(G_n)\le c$ for each $n\in\N$, then \cref{breakers} implies that there exists a string $s\in\Sigma^{b}$ with $P(s)=1$ for each $b\in\N$.  Therefore $P$ satisfies property (A2) of \cref{periodicity}.  Therefore, \cref{periodicity} implies the following result:

\begin{lem}\label{block_colouring}
    If $\afcn(G_n)\le c$ for each $n\in\N$ then there exists $\ell\in\N$ such that, for each $k\in\N$ there exists an $\ell$-periodic string $s\in\Sigma^{k}$ such that $\phi_s$ is an anagram-free vertex colouring of $G_{n_s}$.
\end{lem}

\Cref{near_anagram_fourier,block_colouring} immediately imply:

\begin{lem}\label{near_anagram_graph}
    If $\afcn(G_n)\le c$ for each $n\in\N$ then, for each $r_0\in\N$ and $\epsilon>0$, there exists $r\ge r_0$ and a string $s:=s_1,\ldots,s_{2r}\in\Sigma^{2r}$ with $\|\hist(s_1,\ldots,s_r)-\hist(s_{r+1},\ldots,s_{r2})\|_1\le\epsilon r$ such that $\phi_s$ is an anagram-free vertex colouring of $G_{n_s}$.
\end{lem}

\begin{proof}
    By \cref{block_colouring}, for each $k\in\N$ there exists an $\ell$-periodic string $s'\in\Sigma^k$ such that $\phi_{s'}$ is an anagram-free vertex colouring of $G_{n_{s'}}$.  It is easy to see that, since $\phi_{s'}$ is anagram-free, the string $s'$ is also anagram-free.\todo{Does \cref{near_anagram_fourier} really $s$ to be anagram-free?}
    Thus $s'$ is anagram-free and $\ell$-periodic and is over an alphabet of size $C\le c^{8\ell}$, so applying \cref{near_anagram_fourier} proves the existence of the desired string $s$.
\end{proof}

\cref{near_anagram_graph} shows the existence of colourings of $G_n$ for arbitrarily large values of $n$ that are defined by strings that $\epsilon$-close to being anagramy.  This is where we will obtain our contradiction:

\begin{lem}
    For any $\ell\in\N$, there exists $\epsilon>0$ and $r_0\in\N$ such that, for any integer $r\ge r_0$ and any $\ell$-periodic $s:=s_1,\ldots,s_{2r}\in\Sigma^{2r}$ with $\|\hist(s_1,\ldots,s_r)-\hist(s_{r+1},\ldots,s_{r2})\|_1\le\epsilon r$, the graph $G_{n_s}$ contains a path $P=v_1,\ldots,v_{2m}$ such that $\phi_s(v_1),\ldots,\phi_s(v_{2m})$ is anagramy.
\end{lem}

\begin{proof}
    For each $a\in\Sigma$ define $\delta_a := \hist_a(s_1,\ldots,s_r)-\hist_a(s_{r+1},\ldots,s_{r2})$ and define sets $A_a\subseteq\{i\in \{1,\ldots,r-1\}: s_i=a\}$ and $B_a\subseteq\{i\in\{r+1,\ldots,2r-1\}:s_i=a\}$ as follows:
    \begin{compactenum}
        \item If $\delta_a=0$ then $A_a=B_a=\emptyset$.
        \item If $\delta_a>0$ then $|A_a|=2\delta_x=2|B_a|$.
        \item If $\delta_a<0$ then $|A_a|=\delta_x=\tfrac{1}{2}|B_a|$.
    \end{compactenum}
    The sets $A_a$ and $B_a$ are chosen so that they satisfy the following global \emph{independence constraint}:  There is no pair $i,j\in \bigcup_{a\in\Sigma}(A_a\cup B_a)$ such that $i-j=1$.  To see that this is possible, first observe that we need only concern ourselves with pairs where both $i,j\in\{1,\ldots,r-1\}$ or pairs where $i,j\in\{r+1,\ldots,2r-1\}$.  Thus, we can choose the elements of $A_a$, for $a\in\Sigma$ and then indpendently choose the elements of $B_a$, for all $a\in\Sigma$.

    We show how to choose the elements of $A_a$ for each $a\in\Sigma$.  The same method works for choosing the elements in $B_a$. Observe that, because $s$ is $\ell$-periodic, $|\{i\in \{1,\ldots,r-1\}:s_i=a\}|\ge (r-1)/\ell$ for each $a\in\Sigma$.  This allows us to greedily choose the elements in $A_a$ for each $a\in\Sigma$. At each step we simply avoid choosing $i$ if $i-1$ or $i+1$ have already been in some previous step.  At any step in the process, at most $\epsilon r$ elements have already been chosen in previous steps and each of these eliminates at most $2$ options.  Therefore, there will always be an element available to choose, provided that $2\epsilon r < (r-1)/\ell$.  This is satisfied for any $\epsilon < (r-1)/(2r\ell)$. In particular, for any $r\ge r_0\ge 2$, $\epsilon < 1/(4\ell)$ works.

    We now construct the path $P$ in a piecewise fashion.  For each $i\in\{1,\ldots,2r\}$, let $H_i:=G[n_{s,i},n_{s,i+1}-4]$. The subgraph $H_1,\ldots,H_{2r}$ are what is referred to above as colourful blocks.  The colouring $V(B_i)$ by $\phi_s$ is defined by $s_i$.
    \begin{compactenum}
        \item For each $a\in\Sigma$ such that $\delta_a>0$, group the elements of $A_a$ into pairs.  For each pair $(i,j)$, $P$ contains the path through the top row of $H_i$ and the path through the bottom row of $H_j$.  For each element $i\in B_a$, $P$ contains the zig-zag path with both endpoints in the top row of $H_i$ and that contains every vertex of $H_i$.  (Note that the zig-zag path begins at the top and bottom row because $H_i$ is a $t$-block for $t$ a multiple of $4$; in particular, $t$ is even.)

        \item For each $a\in\Sigma$ such that $\delta_1<0$ we proceed symmetrically to the previous case, but reversing the roles of $A_a$ and $B_a$.  Specifically, we group the elements of $B_a$ into pairs.  For each pair $(i,j)$, $P$ contains the path through the top row of $H_i$ and the path through the bottom row of $B_j$.  For each element $i\in A_a$, $P$ contains the zig-zag path with both endpoints in the top row of $H_i$ and that contains every vertex of $H_i$.

        \item For each $i\in\{1,\ldots,2r\}\setminus\bigcup_{a\in\Sigma}(I_a\cup B_a)$, $P$ contains the top row of $H_i$.
    \end{compactenum}
    The rules above define the intersection $P_i$ of $P$ with each colourful block $H_i$ of $G_{n_s}$.  If $P_i$ is the path through the bottom (top) row of $H_i$ then we call $H_i$ a \emph{bottom (top) block}.  If $P_i$ is the zig-zag path that contains every vertex of $H_i$ then we call $H_i$ a \emph{zig-zag block}.  Note that $\sum_{a\in\Sigma} \delta_a = 0$ and this implies that the number of bottom blocks among $H_1,\ldots,H_{r-1}$ is the same as the number of bottom blocks among $H_{r+1},\ldots,H_{2r}$.  Indeed, this number is exactly $\beta:=\tfrac{1}{2}\sum_{a\in\Sigma} |\delta_a|=\tfrac{1}{2}\|\hist(s_1,\ldots,s_r)-\hist(s_{r+1},\ldots,s_{2r})\|_1$.

    We now define how $P$ behaves for the boring blocks, that we name $Q_0,\ldots,Q_{2r-1}$. The first boring block $Q_0$ comes immediately before $H_1$. Each boring block $Q_j$, for $j\in\{1,\ldots,2r-1\}$ comes immediately after $H_j$ and immediately before $H_{j+1}$.\todo{Deal with stupid boundary case where \cref{near_anagram_fourier} gives a prefix of $s$.}  In almost every case, $P$ uses the path through the top row of $Q_j$.  The only exceptions are when $H_j$ or $H_{j+1}$ are bottom blocks. Note that, because of the global independent constraint, these two cases are mutually exclusive:
    \begin{compactenum}
        \item When $H_j$ is a bottom block $P$ uses a path that begins at the bottom row of $Q_j$ but moves immediately to the top row of $Q_j$ and uses the entire path along the top row. We call this a \emph{down-up} path.
        \item When $H_{j+1}$ is a bottom block, $P$ uses a path that begins at the top row of $Q_j$ and moves immediately to to the bottom row of $Q_j$ ad uses the entire path along the bottom row.  We call this a \emph{up-down} path.
    \end{compactenum}
    This completely defines the path $P:=v_1,\ldots,v_{2m}$, all that remains is to argue that $\rho:=\phi_s(v_1),\ldots,\phi_s(2m)$ is anagramy.

    Observe that the number of downup paths and the number of updown paths in $Q_0,\ldots,Q_{r-1}$ is exactly the same as the number of bottom blocks among $H_1,\ldots,H_{r-1}$ which is exactly $\beta$.  Similarly, the number of updown paths and downup paths in $Q_{r+1},\ldots,Q_{2r-1}$ is exactly $\beta$.  Now every path that is neither downup nor updown uses the top row.  This implies that the sequence of colours contributed to $\rho$ by  the intersection of $P$ with $Q_0,\ldots,Q_{r-1}$ is a permutation of the sequence of colours contributed to $\rho$ by the intersection of $P$ with $Q_{r+1},\ldots,Q_{2r-1}$.

    Finally, by construction, each pair of top and bottom blocks in $H_1,\ldots,H_{r-1}$ contributes exactly the same amount as a single matching zig-zag block in $H_{r+1},\ldots,H_{2r-1}$.  Specifically, if $x,y\in A_a$, and $z\in B_a$, $H_x$ is a top block, $H_y$ is a bottom block and $H_z$ is a zig-zag block, then the contributions of $P_x$ and $P_y$ to $\rho$ cancels out the contribution of $P_z$. After doing this cancellation exhaustively, all that remains are top blocks, which also cancel each other perfectly.  This completes the proof.
\end{proof}


%
%
%
%
%
%
%
% \section{Dead}
%
%
%
%
%
%
%
%
%
%
%
% Let $A=\{a_i:i\in\N\}$ and $B:=\{b_i:i\in\N\}$ be two infinite sets indexed by natural numbers.  Let $G$ be the graph with vertex set $V(S):=A\cup B$  and edge set
% \[
%     E(G) := \bigcup_{i=0}^{\infty} \{a_ib_i,a_ia_{i+1},b_ib_{i+1}\} \enspace
% \]
% % It is easy to see that $\pw(G)=2$
% % The graph $G$ has pathwidth at least $2$ because, it contains, for example, the $4$-cycle $a_1a_2b_2b_1$.  It has pathwidth at most $2$ because it has a path decomposition $(B_x:x\in V(P))$ whose largest bag has size $3$.  Specifically, $P:=(0,1,2,\ldots)$, $B_{2i}:=\{a_{i},a_i,b_{i+1}\}$, and $B_{2i+1}:=\{a_{i},a_{i+1},b_{i+1}\}$ for each $i\in\N$.
%
% For each $i,j\in\N$ with $i\le j$, define $G[i,j]:=G[\bigcup_{k=i}^j\{a_k,b_k\}]$ and we call $G[i,j]$ a \emph{$(j-i)$-block}.  For each $n\in\N$, $G_n:=S[0,n]$.  Note that each $t$-block $G[i,i+t]$ is isomorphic to $G_t$ with the mapping $f:G_t\to V(G[i,i+t])$ given by $f_i(a_{j}):=a_{i+j}$ and $f_i(b_{j}):=b_{i+j}$ for each $j\in\{0,\ldots,t\}$; see \cref{g_n}.
%
%
% For each $n\in\N$, let $\Phi_n$ denote the set of vertex $c$-colourings of $G_n$. Since $G_n$ has $2n+2$ vertices, $|\Phi_n|=c^{2n+1}$.  Given some $\phi\in\Phi_n$, each $t$-block $S[i,i+t]$ defines an edge colouring $\phi_{i,t}\in \Phi_t$ of $S_t$ given by $\phi_{i,t}(v):=\varphi(f_i(v))$. For odd $n\ge 1$, define $s_\phi:=\langle\sigma_{2i,1}:i=0,\ldots,(n-1)/2\}$.  That is, $s_\phi$ is a sequence of vertex colourings in $\Phi_1$.  Each of these colourings is a colouring of the $4$-cycle $a_1b_1b_2a_2$.
%
% \begin{lem}\label{periodic_vertex_colouring}
%     If $\afcn(G_n)\le c$ for each $n\in\N$, then there exists $\ell\in\N$ and $\Phi\subseteq\Phi_1$ such that, for each $b\in\N$,
%     \begin{compactenum}
%         \item $G_{2b-1}$ has at least one anagram-free vertex colouring $\phi$ with $s_\phi\in\Phi^{b}$; and
%         \item each anagram-free vertex colouring $\phi$ of $G_{2b-1}$ with $\phi\in\Phi^{b}$ is $\ell$-periodic.
%     \end{compactenum}
% \end{lem}
%
%
% \begin{lem}\label{fixed_breaker_blocks}
%     If $\phi:V(G_{2b-1})\to\{1,\ldots,c\}$ is an anagram-free vertex colouring of $G_n$ then $\phi':V(G_{5b}\to\{1,\ldots,c+6\}$ in which
%     \[
%         DEFINE \phi'
%     \]
%     is an anagram-free colouring of $G_{5b-1}$.
% \end{lem}
%
%
% \begin{proof}[Proof of \cref{main_vertex}]
%     Suppose, for the sake of contradiction, that $\afcn(G_n)\le c$ for each $n\in\N$.  Then applying \cref{periodic_vertex_colouring} and \cref{near_anagram_fourier}, we find some $N\in\N$ and some anagram-free vertex $c$-colouring of $G_N$ that, contains a subgraph isomorphic to $G_n$ that has a colouring $\phi:V(G_{4b-1})\to\{1,\ldots,c\}$ such that $\|\hist(\phi_{0,1},\ldots,\phi_{2b-1,1})-\hist(\phi_{2b,1},\ldots,\phi_{4b-1,1})\|\le\epsilon b$.In
%
%     For each $i\in\{0,\ldots,b-1\}$, let $\alpha_i:=\phi_{2i,1}$ and $\beta_i:=\phi_{2b+2i}$. Let $\alpha:=\alpha_0,\ldots,\alpha_{b-1}$ adn let $\beta:=\beta_0,\ldots,\beta_{b-1}$.  For each $x\in\Phi_1$, let $\delta_x:=\hist(\alpha)-\hist(\beta)$.
%
%     Define subsets $A,B\subseteq \{1,\ldots,b-2\}$ with the following properties:
%     \begin{compactenum}[(a)]
%         \item There is no pair $i,j\in A$ with $i-j=1$ and no pair $i,j\in B$ with $i-j=1$.
%         \item if $\delta_x>0$ then $|\{i\in A:\alpha_i=x\}|=\delta_x=\tfrac{1}{2}|\{|i\in B:\beta_i=x\}|$
%         \item if $\delta_x<0$ then $|\{i\in A:\alpha_i=x\}|=2\delta_x=2|\{|i\in B:\beta_i=x\}|$.
%         \item if $\delta_x=0$ then $|\{i\in A:\alpha_i=x\}|=|\{|i\in B:\beta_i=x\}|=0$.
%     \end{compactenum}
%     The existence of such sets $A$ and $B$ is not difficult since their total size is only $\epsilon n$ and $\alpha$ and $\beta$ each contain at least $n/2\ell$ occurrences of each $x\in\Phi_1$.\todo{Give details!}
%
%     Now, construct the colouring $\phi'$ of $G_{5b-1}$ defined in \cref{fixed_breaker_blocks}.  We will show that $G_{5b-1}$ contains a path $P$ from $a_0$ to $a_{5b-1}$ whose colour sequence is anagramy.  For each $x\in\Phi_1$, let $A_x:=\{i\in A:\alpha_i=x\}$ and let $B_x:=\{i\in B:\beta_i=x\}$.
%
%     Let $x\in\Phi_1$ be such that $\delta_x>0$.
%     For each $i\in A_x$, $P$ contains the subpath $a_rb_rb_{r+1}a_{r+1}$ for the appropriate value of $r<2b$.\todo{Define $r$}.  Now, partition the values in $B_x$ into $\delta_x$ pairs. For each pair $P$ will contain the subpaths $a_{r_1}a_{r_1+1}$ and $b_{r_1}b_{r_1+1}$.
%
%     For $x\in\Phi_1$ such that $\delta_x < 0$ we proceed symmetrically, reversing the roles of $A$ and $B$.
% \end{proof}
%
%
%
% %
% %
% % Let $b\in\N$, let $n:=2b$, and let $\phi:V(G_n)\to\{1,\ldots,c\}$ be a vertex colouring of $G_n$.  For each $i\in\{0,\ldots,b-1\}$, let $\sigma_
% %
%
%
%
% \todo[inline]{Come up with a similar argument to show that anagram-free vertex colouring of $S_n$ with a constant number of colours is not possible.}
%
% \todo[inline]{See if we could even do the graph $2\times n$ grid that Wilson conjectures can't be anagram-free coloured with a constant number of colours.}
%
%
%
%
% \section{Edge Colouring}
% \label{edge_colourings}
%
% Let $A=\{a_i:i\in\N\}$ and $B:=\{b_i:i\in\N\}$ be two infinite sets indexed by natural numbers.  Let $S$ be the graph with vertex set $V(S):=A\cup B$  and edge set
% \[
%     E(S_n) := \bigcup_{i=0}^{\infty} \{a_ib_i,a_ia_{i+1},b_ib_{i+1},a_ib_{i+1}\} \enspace
% \]
% (see \cref{s_n}).  The graph $S$ has pathwidth at least $2$ because, for example $a_1b_1b_2$ is a clique on $3$ vertices.  It has pathwidth at most $2$ because it has a path decomposition $(B_x:x\in V(P))$ whose largest bag has size $3$.  Specifically, $P:=(0,1,2,\ldots)$, $B_{2i}:=\{a_{i},a_i,b_{i+1}\}$, and $B_{2i+1}:=\{a_{i},a_{i+1},b_{i+1}\}$ for each $i\in\N$.
%
% For any $i,j\in\N$ with $i\le j$, define $S[i,j]:=S[\bigcup_{k=i}^j\{a_k,b_k\}]$ and we call $S[i,j]$ a \emph{$(j-i)$-block}.  For each $n\in\N$, $S_n:=S[0,n]$.  Note that each $t$-block $S[i,i+t]$ is isomorphic to $S_t$ with the mapping $f:S_t\to V(S[i,i+t])$ given by $f_i(a_{j}):=a_{i+j}$ and $f_i(b_{j}):=b_{i+j}$ for each $j\in\{0,\ldots,t\}$; see \cref{s_n}.
%
% \begin{figure}
%     \begin{center}
%     \includegraphics{figs/s_n}
% \end{center}
% \caption{The graph $S_n$}
% \label{s_n}
% \end{figure}
%
% For each $n\in\N$ let $\Phi_n$ be the set of edge $c$-colourings of $S_n$.  Since $S_n$ has $2n+1$ edges, $|\Phi_n|=c^{2n+1}$.
% Given some $\varphi\in\Phi_n$, each $t$-block $S[i,i+t]$ defines an edge colouring $\varphi_{i,t}\in \Phi_t$ of $S_t$ given by $\varphi_{i,t}(v):=\varphi(f_i(v))$.  For any $b\in\N$, $n:=3b$, and any edge  colouring $\varphi$ of $S_n$, we define the \emph{$3$-block colour sequence} $s_\varphi:=\langle \varphi_{3i,3}: i=0,\ldots,b\rangle$.  We say that $\varphi$ is \emph{$3$-block $\ell$-periodic} if $s_\varphi$ is $\ell$-periodic.
%
% \begin{lem}\label{block_breakers}
%     If $\afci(S_n)\le c$ for each $n\in\N$ then there exists an integer $\ell_3:=\ell_3(c)$ and an edge colouring $c_3\in\Phi_3$ such that, for each $n\in\N$ there exists an anagram-free edge $c$-colouring of $S_n$ that is $3$-block $\ell$-periodic.
% \end{lem}

% For any string $s\in \Sigma^*$, define \emph{parity histogram} $\p(s):=(\h_a(s)\bmod 2: a\in\Sigma)$.



 % the $|A|$-vector indexed by elements of $A$ where $p_a




% \begin{proof}
%     If the statement is true for $S_n$ then it is true for all $n'\le n$. Thus, we may assume that $n=2b$ is even.  A sequence $\varphi_0,\ldots,\varphi_{b-1}$ of edge $c$-colourings of $S_2$ is \emph{compatible} if $\varphi_{i}(a_{2}b_{2})=\varphi_{i+1}(a_0b_0)$ for each $i\in\{0,\ldots,b-1\}$. Observe that any compatible sequence $\varphi_0,\ldots,\varphi_{b-1}$ defines an edge colouring of $S_n$ by colouring $S[2i,2i+2]$ using $\varphi_i$ for each $i\in\{0,\ldots,b-1\}$.
%
%     The predicate $P$ defined by the statement
%     ``$\varphi_0,\ldots,\varphi_{b-1}$ defines an anagram-free edge colouring of $S_n$'' satisfies assumption (A1) of \cref{periodicity}.  The assumption that $\afci(S_n)\le c$ ensures that $P$ also satisfies assumption (A2).  Therefore, by \cref{periodicity} there exists a sequence $\varphi_0,\ldots,\varphi_{b-1}$ that defines an anagram-free edge $c$-colouring of $S_n$ and is $\ell$-periodic.
% \end{proof}
%
% Let $n:=2b$, let $\varphi$ be an edge $c$-colouring of $S_n$, let $c_2\in\Phi_2$, and let $I=\{i\in\{0,\ldots,b-1\}:\varphi_{2i,2}=c_2\}$ and label the elements of $I$ as $i_0<i_1<\cdots<i_k$. Consider the sequence of blocks $C_1,\ldots,C_k$ where $C_q:=S[2i_q+1,2i_{q+1}]$ and let $t_q:=i_{q+1}-i_q$ for each $q\in\{1,\ldots,k\}$.  Each $C_q$ is a $2t_q$-block and it defines a colouring $\zeta_q:=\varphi_{2i_q,t_q}$.  Define $s_{\varphi,c_2}:=\zeta_1,\ldots,\zeta_k$.
%
% \begin{lem}
%     If $\afci(S_n)\le c$ for each $n\in\N$ then there exists an integer $\ell:=\ell(c)$ and an edge colouring $c_2\in\Phi_2$ such that, for each $n\in\N$ there exists an anagram-free edge $c$-colouring such that any length-$\ell$ substring of $s_\varphi$ contains $c_2$ and the $s_{\varphi,c_2}$ is $\ell$-periodic.
% \end{lem}
%
% \begin{proof}
%     By \cref{block_breakers} there exists $c_2\in\Phi_2$ and, for each $b\in\N$, there is a colouring $\varphi^{(b)}$ of $S_{2b}$ so that every length $\ell_2$ substring of $s_{\varphi^{(b)}}$ contains $c_2$.  Let $I_n:=\{i\in\{1,\ldots,b\}:\varphi_{2i,2}=c\}$.
% \end{proof}
%
%
%
%
%
%
% Then the graph $S_n-\{\bigcup_{i\in I}\{a_{2i+1},b_{2i+1}\}$ contains $k$ components $C_1,\ldots,C_{|I|-1}$ where each component $C_k:=S[2i+2,2j]$ for distinct $i,j\in I$.  (It may also contain up to two additional components, one that contains $S[0,0]$ and one that contains $S[n,n]$.)  It component $C_k$ is a $t$-block for some $t\le 2\ell$, which is
%
% % $ contains two vertices of $S[i:i+2]$ and two vertices for $S[j:j+2]$ for distinct $i,j\in I$.  Each component
%
%
%
%
%
% Note that each graph $S_n$ is a subgraph of the infinite graph $S:=S_\infty$.  For each
%

% Our first result shows that the anagram-free chromatic index of $S_n$ is unbounded.
%
% \begin{thm}\label{edge_colouring}
%     For any $c\in\N$, there exists $n\in\N$ such that, for any edge $c$-colouring $\varphi:E(S_n)\to\{1,\ldots,c\}$ of $S_n$, there exists a path $v_0,\ldots,v_{2r}$ in $S_n$ such that $\varphi(v_0v_1),\ldots,\varphi(v_{r-1}v_r)$ is a permutation of $\varphi(v_rv_{r+1},\ldots,v_{2r-1}v_{2r})$.
% \end{thm}
%
% Our strategy is break $S_n$ up into \emph{blocks} whose size is upper bounded by some value $\ell$ depending only on $c$. More precisely, for each  using the mapping $\rho:V(S_{i,i+t})\to V(S_t)$ given by $\rho(a_{i+j}):=a_{j}$ and $\rho(b_{i+j}):=b_{j}$.  In this way, any (edge or vertex) colouring $\varphi$ of $S[i,i+t]$ defines a colouring $\varphi_{i,t}:V(G)$ of $S_t$.  We say that two $t$-blocks $B_{i,t}$ and $B_{j,t})$ have the same colouring (under $\varphi$) if $\varphi_{i,t}=\varphi_{j,t}$.
%
% Let $S_n':=S_n-\{a1b_1,a_nb_n\}$. We need the following easy constructions that allow the kind of four versus six cancellation described earlier.  These three lemmas are illustrated in \cref{good_paths}:\todo{Write these paths down for the visually impaired.}
%
% \begin{figure}
%     \begin{center}
%         \begin{tabularx}{\textwidth}{XXX}
%         % \multicolumn{2}{c}{$P$} \\
%         % \includegraphics{figs/pq-1} \newline
%         % \includegraphics{figs/pq-2} \newline
%         % \includegraphics{figs/pq-3} \newline
%         % \includegraphics{figs/pq-4} &
%         \includegraphics{figs/pq-8} \newline
%         \includegraphics{figs/pq-9} \newline
%         \includegraphics{figs/pq-10} \newline
%         \includegraphics{figs/pq-11} &
%         % \multicolumn{2}{c}{$Q$} \\
%         % \includegraphics{figs/pq-5} \newline
%         % \includegraphics{figs/pq-6} \newline
%         % \includegraphics{figs/pq-7} &
%         \includegraphics{figs/pq-12} \newline
%         \includegraphics{figs/pq-13} \newline
%         \includegraphics{figs/pq-14} &
%         \includegraphics{figs/r-8} \newline
%         \includegraphics{figs/r-9} \newline
%         \includegraphics{figs/r-10}
%         \end{tabularx}
%     \end{center}
%     \caption{The paths $P_1,\ldots,P_4$ and $Q_1,\ldots,Q_3$, and $R_1,\ldots,R_4$ in $S_n$.}
%     \label{good_paths}
% \end{figure}
%
% \begin{lem}
%     For each $n\ge 3$, the graph $S_n'$ contains four paths $P_1,\ldots,P_4$.  For each $(x,y)\in\{a_1,b_1\}\times\{a_n,b_n\}$ exactly one of these paths begins at $x$ and ends at $y$.  Each edge of $S_n'$ is used by exactly two of these paths.
% \end{lem}
%
% \begin{lem}
%     For each $n\ge 3$, the graph $S_n'$ contains three paths $Q_1,\ldots,Q_3$ that each begin at a vertex in $\{a_1,b_1\}$ and at a vertex in $\{a_3,b_3\}$.  Each edge in $S_n'$ is used in exactly one of these paths.
% \end{lem}
%
%
% In addition to the path sets described above, we use three paths in $S_3$, $R_1:=a_1\rightsquigarrow a_3$, $R_2:=a_1\rightsquigarrow b_3$ and $R_3:=b_1\rightsquigarrow a_1$ that allows us to connect blocks without interfering with larger adjacent pieces.
%
% \begin{lem}
%     The graph $S_3'$ contains three paths $R_1,\ldots,R_3$. For each $(x,y)\in\{(a_1,a_3),(a_1,b_3),(b_1,a_1)\}$ exactly one of these paths begins at $x$ and ends at $y$ and this path includes exactly one of $\{a_1,b_1\}$ and exactly one of $\{a_3,b_3\}$.
% \end{lem}
%
% Observe that, for $n=2b+1$, we can always thinking of $S_n$ as a sequence of $b$ $3$-blocks $\langle B_{2j+1,3}: j=0,\ldots,b-1\rangle$.
%
%
% Our first step is to break $S_n$ up into blocks of length at most $2\ell$ using a sequence of $3$-blocks that all have the same colouring.  We begin with the following immediate consquence of \cref{periodicity}.
%
% \begin{lem}\label{block_breaker}
%     If $\afci(S_n)\le c$ for each $n\in\N$ then there exists an integer $\ell$ and an edge $c$-colouring $\varphi^*$ of $S_3$ such that, for each $b\in\N$, there exists an anagram-free edge $c$-colouring $\varphi:E(S_{2b+1})\to\{1,\ldots,c\}$ such, for each $i\in\{0,\ldots,b-\ell-1\}$ XXXXXa;lskdfjl;kadsjfqjw o;eiu3qp4 that the sequence $\langle \varphi_{2i+1,3}:i=0,\ldots,b-1\rangle\in\Phi^b$ and is $\ell$-periodic.
% \end{lem}
%
% Let $\ell$ and $\Phi$ be the integer and set of colouring of $S_3$ given by \cref{block_breaker}.  For each $b\in\N$, fix a particular anagram-free edge $c$ colouring $\varphi^{(b)}$ of $S_{2b+1}$ satisfying the conditions of \cref{block_breaker}. For each $b\in\N$, let $J_{b}:=\{j\in\{0,\ldots,b-1\}:\varphi^{(b)}_{2j+1,3}=\varphi^*\}$.  Finally, let $\Phi_b$ be the set of all anagram-free edge $c$-colourings $\varphi$ of $S_{2b+1}$ such that $\varphi_{2j+1,3}=\varphi^*$ for each $j\in J_b$.  Under the assumption of \cref{block_breaker}---namely that $\afci(S_n)\le c$ for each $n\in\N$---we know that $\Phi_b$ is non-empty for all $b\in\N$.
%
% Now, consider the set $J_b$ for some $b\in\N$ and let $j_1<j_2<\cdots<j_k$ be the elements of $J_b$.  Each pair of consecutive elements $j_{x},j_{x+1}\in J$ defines a block $B_x:=B_{2j_x+3,2(j_{x+1}-j_x-1)}$ that begins where $B_{j_x,3}$ ends and ends where $B_{j_{x+1},3}$ begins.  For any colouring $\varphi\in\Phi_b$, each block $B_x$ has an associated length $\ell_x=j_{x+1}-j_x$ and colouring $\varphi_x:=\varphi_{2j_x+1,2\ell_x+1}$.  The sequence $\langle (\ell_x,\varphi_x):x=1,\ldots,b-1\rangle$ is certainly anagram-free since, otherwise, the colouring $\varphi$ is not anagram-free.  We can now apply \cref{periodicity} again to show that
%
% \begin{lem}
%     If $\afci(S_n)\le c$ for each $n\in\N$ then there exists an integer $\ell$ and a
%
%
%
%
%     set $\Phi$ of edge $c$-colourings of $S_3$ such that, for each $b\in\N$, there exists an anagram-free edge $c$-colouring $\varphi:E(S_{2b+1})\to\{1,\ldots,c\}$ such that the sequence $\langle \varphi_{2i+1,3}:i=0,\ldots,b-1\rangle\in\Phi^b$ and is $\ell$-periodic.
% \end{lem}
% %
% %
% %
% % Call these blocks $B_1,\ldots,B_{|J|-1}$ so that $B_i$ precedes $B_{j}$ if $a_{V(B_i)$ in this order if $B_{i}:=B_{x,(y-x)} By \cref{block_breaker} $y-x<\ell$, so $B_{}$
%
%
% %
% %  $\Phi_n$ be the set of all anagram-free $c$-colourings of $S_n$ that satisfy the conditions of \cref{block_breaker}. Take any $\varphi^*\in\Phi$ and let $J_\phi:=, for any $\varphi\in\Phi_n$, the
% %
% %
% %
% % Then, for any $b\in\N$ and any edge $c$-colouring of $S_n$
% %
% % Let $\ell$ and $\varphi^*$ be an integer and an edge $c$-colouring of $S_3$ that satisfy the conditions of \cref{block_breaker}.  If $\afci(S_n)\le c$ for each $n\in\N$, then, for each $n\in\N$, $S_n$ has a non-empty set $\Phi_n$ of edge $c$-colourings satisfying the conditions of \cref{block_breaker}. For each $\varphi\in \Phi_n$, consider the subset $J:=\{j\in\{0,\ldots,b-1\}:\varphi_{2j+1,3}=\varphi^*\}$.
%
% %
% %
% %
% %  This defines a set $B$ of $|J|-1$ maximal blocks in $S_n$ each of the form $B_{2j+3,\ell_j}$ where $j\in J$ and $\{j,\ldots,j+(\ell-1)/2\}\cap J=\{j,j+(\ell-1)/2\}$.  In words, each block in $B$ is bookended by a pair of $3$-blocks coloured with $\varphi^*$.  Furthermore, $\ell_j\le
% %
%
%
%
%
%
%
% For each $n\in\N$, there
%
%
%
%
%
% Observe that, for $n=2t+1$, $S_n$ can be constructed by gluing together $t$ copies of $S_3$ where the vertices $a_3$ and $b_3$ in each copy are identified with the vertices $a_1$ and $b_1$ in the next copy.
%
%
% In our proof we will not use the edges $a_{2x+1}b_{2x+1}$ for any $x\in\{0,\ldots,t\}$  (which is why these edges are lighter in \cref{s_n}).  Thus, the graph we are really interested in is the graph obtained by gluing together $t$ copies of $S_3'$.  We now proceed with the proof of \cref{edge_colouring}.
%
% \begin{proof}[Proof of \cref{edge_colouring}]
%   Consider the graph $S_N$ for a very large value $N:=2t+1$ to be discussed shortly.  As discussed above, this graph is obtained by from $t$ copies of $S_3$ and we will only make use of the edges in $S_3'$.  The graph $S_3'$ has $7$ edges and therefore has a set $X$ of $c^7$ possible edge $c$-colourings.
%   For $X'\subseteq X$, we say that an edge colouring of $S_N$ is $X'$-restricted each of the $t$ copies of $S_3$ uses a colouring in $X'$.
%
%   Suppose, for the sake of contradiction, that $S_N$ has anagram-free edge-colouring that uses $c$ colours, for every $N\in\N$.  Take a minimal subset $X'\subseteq X$ such that $S_N$ has an $X'$-restricted anagram-free $c$-edge colouring for every $N\in\N$.  This implies that there exists an integer $\ell:=\ell(X')$ such that, for every $N\in\N$, every $i\in\{0,\ldots,t-\ell\}$, every $X'$-restricted anagram-free edge $c$-colouring of $S_N$ and every $\rho\in X$, the subgraph of $S_N$ induced by $\{a_{2i+1},\ldots,a_{2(i+\ell)+1}\}\cup \{b_{2i+1},\ldots,b_{2(i+\ell)+1}\}\}$ contains a copy of $S_3'$ coloured using $\rho$.
%
%
%   Fix some $X'$-restricted anagram-free edge $c$-colouring $\varphi$ of $S_N$.
%   Now select any $\rho\in X'$ and use each occurrence of the colouring $\rho$ to break $S_N$ into blocks, each of length at most $\ell$ with each pair of consecutive blocks separated by a copy of $S_3'$ coloured using the colouring $\rho$.  Now, each block is a copy of $S_k$ for some $k\in\{3,\ldots,\ell-1\}$.  The graph $S_k'$ has $4k-5$ edges and therefore has at most $c^{4k-5}$ possible edge $c$-colourings.  Thus, there are at most $\sum_{k=3}^{\ell-1} c^{4k-5} < c^{4\ell-5}$ types of blocks.\todo{constants.}
%
%   These blocks define a string $s_0,\ldots,s_m$ over an alphabet $\Sigma$ of size $C\le c^{4\ell-4}$.  Let $r_0:=10^{100}$ and $\epsilon=1/1000000c^{4\ell-4}\ell$. Note that $\epsilon$ and $r_0$ depends only on $\ell$, which depends only on $X'$, which depends only $c$.  None of these values depends on $N:=2t+1$.  Therefore, by \cref{near_anagram_fourier}, we can choose $t$ sufficiently large to obtain a substring $p:=p_1,\ldots,p_{2r}$ of $s_0,\ldots,s_m$ whose length is $2r>2r_0$ and such that $\|\hist(p_1,\ldots,p_{r})-\hist(p_{r+1},\ldots,p_{2r})\|_1\le \epsilon r$.
%
%   The substring $p_1,\ldots,p_{2r}$ corresponds to a sequence of $2r$ blocks in the original graph $S_n$. For each $x\in X'$, let $\delta_x:=\hist_x(p_1,\ldots,p_r)-\hist_x(p_{r+1},\ldots,p_{2r})$.  By \cref{near_anagram_fourier}, $|\delta_x|\le \epsilon r$.
%
%   To deal with the fact that $\delta_x>0$ we need $6\delta_x$ copies of $x$ in $p_1,\ldots,p_r$ and $4\delta_x$ copies of $x$ in $p_{r+1},\ldots,p_{2r}$.  By using paths $Q_1,\ldots,Q_3$ ($2\delta_x$ times each) in the first half and using $P_1,\ldots,P_r$ ($\delta_x$ times each) in the second half we are able to cancel everything.\todo{First deal with the parity issue. (First $S_3$ colourings, then $S_{\le\ell}$ colourings, then parity vectors.)}  This is not a problem because each of these contains at least $r/\ell$ copies of $x$.  Doing this for each $x\in X'$ gives rise to a demand for a total of at most
%   \[
%     \sum_{x\in |X'|} 4|\delta_x| \le \sum_{x\in |X'|} 4\epsilon r = 4|X'|\epsilon r\le 4c^7\epsilon r
%   \]
%   elements from each half.
%   \todo[inline]{Explain that we use an independent set of blocks and how we (easily) get it.}
%   \todo[inline]{Explain that every block we don't use just uses the straight path $a_1,\ldots,a_r$ across the top.}
%   \todo[inline]{Explain that, for each of the three types of connector blocks, that type of block is used the same number of times in the first half and in the second half, so these connectors cancel each other out.}
% \end{proof}
%
%
%





\section{Proof of \cref{near_anagram_fourier}}
\label{near_anagram_proof}

\todo[inline]{This proof is taken from a draft of an older paper that was proving a lower bound for anagram-free vertex colouring.  Eventually, we found a simpler argument, so we never used this proof.  Right now, it proves the existence of a $2$-balanced substring but the same technique should work to give an $\epsilon$-balanced substring.  I also think this lemma (and probably a better quantitative version) has a proof using Fourier approximation, but I don't know enough about Fourier approximation.}


\begin{proof}[Proof of \cref{near_anagram_fourier}]
  Call a string a \emph{$c$-string} if it is over an alphabet of size $c$
  and call a string \emph{good} if it contains no balanced substring.
  For each $c\in\N$, let $h_c$ denote the minimum integer for which
  there is no good $c$-string of length $2^{h_c}$.  Thus, our goal is
  to show that $h_c$ is finite for each $c\in\N$.
  Suppose this is not true so that there exists some minimum value
  $c$ for which $h_c$ is infinite.  Choosing the minimum such value of
  $c$ ensures that $h_{c-1}$ is finite and that any good (sub)string of
  length at least $r:=2^{h_{c-1}}$ uses an alphabet of size at least $c$.

  Let $s$ be a good string over the alphabet $\Sigma=\{1,\ldots,c\}$ and having
  length $r2^{h}$, for some value $h$ to specified shortly.   Consider
  the complete binary tree $T$ of height $h$ whose leaves, in order,
  are the length-1 substrings of $s$ and for which each internal node is
  the substring obtained by concatenating the node's left and right child.
  See \cref{binary_tree}.

  \begin{figure}
    \begin{center}
       \includegraphics[width=\textwidth]{figs/binary-tree-1}
    \end{center}
    \caption{Building a binary tree $T$ over the string $s$.}
    \label{binary_tree}
  \end{figure}

  For each node $v$ of $T$, let $h(v)$ denote the height of $v$'s subtree
  and $s(v)=2^{h(v)}$ denote the length of the string $v$. For each
  $i\in\Sigma$, let $w_i(v):=n_i(v)/s(v)$.  Note that $0\le w_i(v)\le
  1/2$ and that $\sum_{i\in\Sigma} w_i(v)=1$.  Furthermore, if $v$
  has two children $x$ and $y$, then $w_i(v) = (w_i(x)+w_i(y))/2$.
  The assumption that $s$ has no balanced substring implies $v$ is
  $i$-unbalanced, for some $i{t}\in\Sigma$.  Assign each internal node
  $v$ of $T$ the \emph{label} $\ell(v):=\min\{i\in\Sigma: \mbox{$v$
  is $i$-unbalanced}\}$.

  \begin{figure}
    \begin{center}
       \includegraphics[width=\textwidth]{figs/binary-tree-3}
    \end{center}
    \caption{The tree $T$ with the vector $(w_1(v),\ldots,w_5(v))$ for each
     internal node $v$.  The unbalanced index that defines $\ell(v)$ is highlited for each node.}
    \label{binary_tree_2}
  \end{figure}

  For each $i\in\Sigma$, let $S_i=\{v\in V(T): \ell(v)=i\}$ and observe that
  \[
      \sum_{v\in V(T)}s(v)=\sum_{i\in\Sigma} \sum_{v\in S_i} s(v) = (h+\log_2 r)r2^{h}
  \]
  and therefore, there exists some $i^*\in\Sigma$ such that $\sum_{v\in
  S_{i^*}}s(v)\ge (h+\log_2 r)r2^h/c$.  Let $X=S_{i^*}$ and $w=w_{i^*}$.
  From this point on the pro{t}of makes no further reference to the original
  string $s$.  It is helpful to think of $T$ as having being ordered
  so that, for each internal node $v$ with left and right children $x$
  and $y$, respectively, $w(x)\ge w(y)$.  From this point on we use
  the shorthands (for any $R\subseteq V(T)$) $s(R):=\sum_{v\in R}s(v)$
  and $w(R):=\sum_{v\in R}s(v)w(v)/s(R)$.

  Summarizing, we have a complete binary tree $T$ of height $h+\log_2 r$ and
  a subset $X\subseteq V(T)$ with the following properties:
  \begin{enumerate}
    \item For each $v\in V(T)$, $w(v) \le 1/2$.
    \item For each $v\in V(T)$ with $s(v) \ge r$, $w(v)\ge 1/r$.
    \item For each internal node $v\in V(T)$ with children $x$ and $y$,
       $w(v) = (w(x)+w(y))/2$.
    \item $w(X) \ge (h+\log_2 r)r2^{h}/c$.
     \item For each internal node $v\in V(T)\cap X$ with children $x$ and $y$,
       $w(x) > 2w(y)$.\todo{Replace with $w(x)>w(y)+\epsilon/c$}
  \end{enumerate}
  Now, for each $i\in\{1,\ldots,h\}$, let $X_i\subset X$ denote the
  set of nodes $v\in X$ for which the path from the root of $T$ to $v$
  contains exactly $i$ nodes in $X$ (including $v$).  Observe that
  \[  r2^h \ge s(X_1) \ge s(X_2) \ge \cdots\ge s(X_{h+\log_2 r}) \enspace . \]

  We will show that, there exists a constant $t$ such that,
  for each $i\in\{1,\ldots,h-t\}$,
  \begin{equation}
     s(X_{i+t}) \le (1-(1/2)^{t+1}) s(X_i) \enspace . \label{t}
  \end{equation}
  In this way,
  \begin{align*}
     (h+\log_2 r)r2^{h}/c
        \le s(X) & = \sum_{i=1}^{h+\log_2 r} s(X_i) \\
           &\le (\log_2 r)r2^{h}+\sum_{i=1}^{h} s(X_i) \\
           &\le (\log_2 r)r2^{h}+\sum_{i=1}^{h} s(X_{\floor{i/t}+1}) \\
           &\le (\log_2 r)r2^{h}+t\sum_{i=0}^{\floor{h/t}} s(X_{it+1}) \\
           &\le (\log_2 r)r2^{h}+t\sum_{i=0}^{\infty} (1-(1/2)^{t+1})^i s(X_1) \\
           &\le (\log_2 r)r2^{h}+tr2^{h}\sum_{i=0}^{\infty} (1-(1/2)^{t+1})^i  \\
           & = (\log_2 r+t2^{t+1})r2^{h}
  \end{align*}
  which is a contradiction for sufficiently large $h$; in particular, for
  \[
        h \ge (c-1)\log_2 r+ ct2^{t+1} \enspace .
  \]

  It remains to establish \cref{t}, which we do now.  For each node
  $v\in X$, let $R(v)$ denote the unique child of $v$ such that $w(R(v))
  < 2w(v)/3$, i.e., the right child of $v$. (The existence of $R(v)$ follows from Properties~3 and
  5, above).  For a subset $A\subset X$, let $R(A)=\{R(x):x\in A\}$.
  Define $A_0\subseteq X_i$ and, for each $j\ge 1$, define $A_j$
  to be the subset of $X_{i+j}$ that are descendants of some node in
  $R(A_{i-1})$.  See \cref{bigtree}. Observe that $s(A_i) \le s(R(A_{i-1})) = s(A_{i-1})/2$,
  so
   \begin{align*}
      s(X_{i+t})
         &\le (1/2)s(A_0) + (1/2)s(A_1) + \cdots + (1/2)s(A_{t-1}) + s(A_t) \\
         &\le (1/2)s(A_0) + (1/4)s(A_0) + \cdots + (1/2)^t s(A_{0}) + s(A_t) \\
         &  = (1-(1/2)^t)s(A_0) + s(A_t) \enspace .
   \end{align*}
  So all that remains to establish \eqref{t} is to prove that
  $s(A_t)\le (1/2)^{t+1}s(A_0)$.

  \begin{figure}
    \begin{center}
       \includegraphics[width=\textwidth]{figs/bigtree}
    \end{center}
    \caption{The partitioning of $X$ into $X_1,X_2,\ldots,X_h$. Shaded
    nodes are in $X$ and all nodes in $X_i$ are shaded with the same
    colour.   Starting with $A_0=X_1$, the elements of $A_0,\ldots,A_h$
    are highlighted.  The elements of $R(A_0),\ldots,R(A_h)$ are also highlighted.}
    \label{bigtree}
  \end{figure}

  Now, the key inequality is{t}
  \begin{equation}
      w(A_i) \le w(R(A_{i-1}))\cdot\frac{s(R(A_{i-1}))}{s(A_i)}
  \end{equation}
  which implies
  \begin{equation}
       w(A_i) \le (2/3)w(A_{i-1})\cdot\frac{s(A_{i-1})}{2s(A_i)}
             = (1/3)w(A_{i-1})\cdot\frac{s(A_{i-1})}{s(A_i)}
             \label{strings}
  \end{equation}

  Beginning at $A_0$ and repeatedly applying \cref{strings}, we obtain:
  \[
      w(A_t) \le (1/3)^t w(A_0)\cdot\frac{s(A_0)}{s(A_t)}
             \le (1/2)(1/3)^t \cdot\frac{s(A_0)}{s(A_t)} \enspace .
  \]
  On the other hand, $w(A_t)\ge 1/r$, so
  \[
      1/r \le (1/2)(1/3)^t\cdot\frac{s(A_0)}{s(A_t)} \enspace .
  \]
  and rearranging terms yields
  \[
     s(A_t) \le (1/2)(1/3)^t r s(A_0) \le (1/2)^{t+1}s(A_0)
  \]
  for $t = \ceil{\log_{3/2} r}$.
\end{proof}



\end{document}
